import{T as _,o as b,S as A,n as g,i as f,a as o,b as T,d as p,c as E,e as D,f as m,g as C,h as S,j as F,s as k,M as x,k as O,l as w,m as v,_ as R,p as I,q as z,r as h,t as c,u as L,v as M}from"./index-B7lINCpP.js";class l extends _{constructor(){const t=b(l.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new A("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(_.getDefaults(),{callback:g,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,s=>{let e;if(s.state==="started"){s.id!==-1&&this.context.transport.clear(s.id);const i=s.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||f(this._loop)&&this._loop>1){e=1/0,f(this._loop)&&(e=this._loop*this._getLoopDuration());const n=this._state.getAfter(i);n!==null&&(e=Math.min(e,n.time-i)),e!==1/0&&(e=new o(this.context,e));const r=new o(this.context,this._getLoopDuration());s.id=this.context.transport.scheduleRepeat(this._tick.bind(this),r,new o(this.context,i),e)}else s.id=this.context.transport.schedule(this._tick.bind(this),new o(this.context,i))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const s=this.toTicks(t);return this._state.getValueAtTime(s)==="stopped"&&(this._state.add({id:-1,state:"started",time:s}),this._rescheduleEvents(s)),this}stop(t){this.cancel(t);const s=this.toTicks(t);if(this._state.getValueAtTime(s)==="started"){this._state.setStateAtTime("stopped",s,{id:-1});const e=this._state.getBefore(s);let i=s;e!==null&&(i=e.time),this._rescheduleEvents(i)}return this}cancel(t){t=p(t,-1/0);const s=this.toTicks(t);return this._state.forEachFrom(s,e=>{this.context.transport.clear(e.id)}),this._state.cancel(s),this}_tick(t){const s=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(s)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let e=.02;T(this.humanize)||(e=this.toSeconds(this.humanize)),t+=(Math.random()*2-1)*e}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new o(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new o(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,s=this._state.get(t);if(s!==null&&s.state==="started"){const e=this._getLoopDuration();return(t-s.time)%e/e}else return 0}else return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class u extends l{constructor(){const t=b(u.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new A("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(s=>{E(s)?this.add(s[0],s[1]):this.add(s)})}static getDefaults(){return Object.assign(l.getDefaults(),{events:[]})}start(t,s){const e=this.toTicks(t);if(this._state.getValueAtTime(e)!=="started"){s=p(s,this._loop?this._loopStart:0),this._loop?s=p(s,this._loopStart):s=p(s,0);const i=this.toTicks(s);this._state.add({id:-1,offset:i,state:"started",time:e}),this._forEach(n=>{this._startNote(n,e,i)})}return this}_startNote(t,s,e){s-=e,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<e&&(s+=this._getLoopDuration()),t.start(new o(this.context,s))):t.startOffset<this._loopStart&&t.startOffset>=e&&(t.loop=!1,t.start(new o(this.context,s))):t.startOffset>=e&&t.start(new o(this.context,s))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(s=>{s.startOffset+=this._startOffset})}stop(t){const s=this.toTicks(t);return this._state.cancel(s),this._state.setStateAtTime("stopped",s),this._forEach(e=>{e.stop(t)}),this}at(t,s){const e=new D(this.context,t).toTicks(),i=new o(this.context,1).toSeconds(),n=this._events.values();let r=n.next();for(;!r.done;){const d=r.value;if(Math.abs(e-d.startOffset)<i)return m(s)&&(d.value=s),d;r=n.next()}return m(s)?(this.add(t,s),this.at(t)):null}add(t,s){t instanceof Object&&Reflect.has(t,"time")&&(s=t,t=s.time);const e=this.toTicks(t);let i;return s instanceof l?(i=s,i.callback=this._tick.bind(this)):i=new l({callback:this._tick.bind(this),context:this.context,value:s}),i.startOffset=e,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(t){this._state.forEach(s=>{s.state==="started"?this._startNote(t,s.time,s.offset):t.stop(new o(this.context,s.time))})}remove(t,s){return C(t)&&t.hasOwnProperty("time")&&(s=t,t=s.time),t=this.toTicks(t),this._events.forEach(e=>{e.startOffset===t&&(S(s)||m(s)&&e.value===s)&&(this._events.delete(e),e.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(s=>s.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(s=>{s instanceof u?s._forEach(t):t(s)}),this}_setAll(t,s){this._forEach(e=>{e[t]=s})}_tick(t,s){this.mute||this.callback(t,s)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(s=>{s.loopStart=this.loopStart,s.loopEnd=this.loopEnd,s.loop=t,this._testLoopBoundries(s)})}get loopEnd(){return new o(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopEnd=t,this._testLoopBoundries(s)})}get loopStart(){return new o(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopStart=this.loopStart,this._testLoopBoundries(s)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}const B=F({data(){return{track1:[],track2:[],track3:[],isActive1:!1,isActive2:!1,isActive3:!1,timer1:null,timer2:null,timer3:null,Player:null,isActive:!1,timer:null,playing:!1,currentTime:0,currentIndex:0,playArr:[1,3,4,5,8,9,10,12,14,17,19,20,21,22,23,24,25,26]}},components:{},computed:{},async mounted(){var a;this.initKeyNote(),(a=document.querySelector("body"))==null||a.addEventListener("click",async()=>{await k()},!1)},methods:{initKeyNote(){const a={A0:"A0.mp3",C1:"C1.mp3","D#1":"Ds1.mp3","F#1":"Fs1.mp3",A1:"A1.mp3",C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",A2:"A2.mp3",C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",A6:"A6.mp3",C7:"C7.mp3","D#7":"Ds7.mp3","F#7":"Fs7.mp3",A7:"A7.mp3",C8:"C8.mp3"};let t=0,s=[[],[],[]];for(let e in a)s[t].push(e),t++,t=t>=3?0:t;this.track1=s[0],this.track2=s[1],this.track3=s[2]},async playMIDI(){let a=await x.Midi.fromUrl("/ai-music/dist/1.mid");await k();const t=new O({urls:{A0:"A0.mp3",C1:"C1.mp3","D#1":"Ds1.mp3","F#1":"Fs1.mp3",A1:"A1.mp3",C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",A2:"A2.mp3",C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",A6:"A6.mp3",C7:"C7.mp3","D#7":"Ds7.mp3","F#7":"Fs7.mp3",A7:"A7.mp3",C8:"C8.mp3"},release:1,baseUrl:"https://tonejs.github.io/audio/salamander/",onload:()=>{w().then(()=>{a.tracks[0].notes,new u((e,i)=>{t.triggerAttackRelease(i.name,i.duration,e),this.track1.indexOf(i.name)>=0?(clearTimeout(this.timer1),this.isActive1=!0,this.timer1=setTimeout(()=>{this.isActive1=!1},50)):this.track2.indexOf(i.name)>=0?(clearTimeout(this.timer2),this.isActive2=!0,this.timer2=setTimeout(()=>{this.isActive2=!1},50)):(clearTimeout(this.timer3),this.isActive3=!0,this.timer3=setTimeout(()=>{this.isActive3=!1},50))},a.tracks.flatMap(e=>e.notes.map(i=>({time:i.time,name:i.name,duration:i.duration})))).start(0)}),v.start()}}).toDestination();await t.loaded,window.currentSampler=t},handleClose(){location.reload()},handleStart(){this.playing=!0,this.playMIDI(),this.currentTime=0,this.currentIndex=0},handleLoop(){if(this.currentTime=this.currentTime+50,this.playArr[this.currentIndex]*500===this.currentTime&&(this.isActive=!0,this.currentIndex=this.currentIndex+1,setTimeout(()=>{this.isActive=!1},200)),this.currentIndex>=this.playArr.length){clearTimeout(this.timer);return}this.timer=setTimeout(()=>{this.handleLoop()},50)},closeLoop(){clearTimeout(this.timer)},handleCancel(){this.$refs.keyboard.handleFinishAI()}}}),y=a=>(L("data-v-11214635"),a=a(),M(),a),N={class:"test"},V=y(()=>h("br",null,null,-1)),j=y(()=>h("input",{type:"file",id:"midiInput",accept:".mid,.midi"},null,-1)),$={class:"block-box"};function U(a,t,s,e,i,n){return I(),z("div",N,[h("h1",{onClick:t[0]||(t[0]=(...r)=>a.handleStart&&a.handleStart(...r))},"开始音乐"),h("h1",{onClick:t[1]||(t[1]=(...r)=>a.handleClose&&a.handleClose(...r))},"关闭音乐"),V,j,h("div",{class:c(["ball",{active:a.isActive}])},null,2),h("div",$,[h("div",{class:c(["block",{active:a.isActive1}])},null,2),h("div",{class:c(["block",{active:a.isActive2}])},null,2),h("div",{class:c(["block",{active:a.isActive3}])},null,2)])])}const K=R(B,[["render",U],["__scopeId","data-v-11214635"]]);export{K as default};
